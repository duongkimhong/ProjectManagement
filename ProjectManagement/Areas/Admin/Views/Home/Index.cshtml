@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using ProjectManagement.Models

@inject SignInManager<ProjectManagement.Models.ApplicationUser> SignInManager
@inject UserManager<ProjectManagement.Models.ApplicationUser> UserManager
@inject ApplicationDbContext _context

@{
	ViewData["Title"] = "Admin Index";
	Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@{
	var accounts = UserManager.Users.ToList();
	var projects = _context.Projects.Where(p => p.Status != ProjectStatus.Cancelled).ToList();
	//var projectID = "";
	async Task<Projects> ProjectInfo(string id)
	{
		var code = new Guid(id);
		var project = await _context.Projects
			.Include(p => p.ProjectDocument).ThenInclude(t => t.Documents)
			.Include(p => p.Teams).ThenInclude(t => t.TeamMembers)
			.FirstOrDefaultAsync(p => p.Id == code);

		return project;
	}
}

<!-- Body: Body -->
<div class="body d-flex py-lg-3 py-md-2">
	<div class="container-xxl">
		<div class="row align-items-center">
			<div class="border-0 mb-4">
				<div class="card-header py-3 no-bg bg-transparent d-flex align-items-center px-0 justify-content-between border-bottom flex-wrap">
					<h3 class="fw-bold py-3 mb-0">Dashboard</h3>
					<div class="d-flex py-2 project-tab flex-wrap w-sm-100">
					</div>
				</div>
			</div>
		</div> <!-- Row end  -->
		<div class="card mb-3">
			<div class="card-header py-3  bg-transparent border-bottom-0">
				<h6 class="mb-0 fw-bold ">Projects</h6>
			</div>
			<div class="card-body">
				<table id="patient-table" class="table table-hover align-middle mb-0" style="width: 100%;">
					<thead>
						<tr>
							<th>#</th>
							<th>Icon</th>
							<th>Project Name</th>
							<th>StartDate</th>
							<th>EndDate</th>
							<th>Status</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody>
						@{
							int i = 1;
						}
						@foreach (var project in projects)
						{
							<tr>
								<td>@i</td>
								<td class="text-center align-middle">
									<div class="p-1 border" style="width: 50px; height: 50px; overflow: hidden;">
										<img src="@project.Image" class="img-fluid" alt="profile-image">
									</div>
								</td>
								<td>@project.Name</td>
								<td>@project.StartDate</td>
								<td>@project.EndDate</td>
								<td>@project.Status</td>
								<td>
									<div class="btn-group" role="group" aria-label="Basic outlined example">
										<button type="button" 
											class="btn btn-outline-secondary editButton" 
											data-id="@project.Id" 
											data-name="@project.Name" 
											data-image="@project.Image" 
											data-startdate="@project.StartDate" 
											data-enddate="@project.EndDate" 
											data-description="@project.Description")">
											<i class="icofont-edit text-success"></i>
										</button>
										<button type="button" class="btn btn-outline-secondary deleterow" data-toggle="modal" data-target="#deleteConfirmationModal" data-id="@project.Id"><i class="icofont-ui-delete text-danger"></i></button>
									</div>
								</td>
							</tr>
							i++;
						}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>


<!-- Modal -->
<!-- Modal Popup for Edit -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editholidayLabel">Chỉnh sửa</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- Form chỉnh sửa -->
				<form method="post" asp-area="Admin" asp-controller="Projects" asp-action="Edit" enctype="multipart/form-data">
					<div asp-validation-summary="All" class="text-danger"></div>
					<input type="hidden" id="editId" name="Id" />
					<div class="mb-3">
						<label for="editProjectName" class="form-label">Project Name</label>
						<input type="text" class="form-control" id="editProjectName" name="Name" required>
					</div>
					@* <p>Giá trị ASP.NET: @projectID</p>

					<div class="mb-3">
						<label for="editProjectName" class="form-label">Tên dự án</label>
						<input type="text" class="form-control" id="editProjectName" value="@ProjectInfo(projectID)" name="Name" required>
					</div> *@

					<div class="form-group">
						<label for="CoverImage" class="control-label">Hình ảnh</label>
						<div class="input-group">
							<input type="file" class="form-control" id="editFileInput" style="visibility: hidden; position: absolute;" />
							<input type="text" class="form-control" name="CoverImage" id="editCurrentImagePath" readonly />
							<div class="input-group-append">
								<button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('editFileInput').click();">Chọn tệp</button>
							</div>
						</div>
						<div class="text-center mt-2">
							<img id="editCurrentImage" src="" style="max-width: 100px; max-height: 100px;" />
						</div>
					</div>

					<div class="mb-3">
						<label for="editStartDate" class="form-label">Start Date</label>
						<input type="date" class="form-control" id="editStartDate" name="StartDate">
					</div>
					<div class="mb-3">
						<label for="editEndDate" class="form-label">End Date</label>
						<input type="date" class="form-control" id="editEndDate" name="EndDate">
					</div>
					<div class="mb-3">
						<label for="editDescription" class="form-label">Description</label>
						<textarea class="form-control" id="editDescription" name="Description"></textarea>
					</div>
					<div class="mb-3">
						<label for="documents" class="form-label">Documents</label>
						<input type="file" class="form-control" id="documents" name="Documents" multiple>
					</div>
					<div class="mb-3">
						<label>Team Members</label>
						<input type="hidden" id="editSelectedUsersInput" name="editSelectedUsers" />
						<button type="button" class="btn btn-primary" id="editInviteButton">Invite</button>
					</div>
				</form>

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
				<button type="button" class="btn btn-primary">Lưu thay đổi</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal Popup for Invite -->
<div class="modal fade" id="editInviteModal" tabindex="-1" aria-labelledby="editInviteModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editInviteModalLabel">Invite Users</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<h6>List of available users to invite:</h6>
				<table class="table">
					<thead>
						<tr>
							<th scope="col">Username</th>
							<th scope="col">Select</th>
						</tr>
					</thead>
					<tbody>
						<!-- Render users dynamically here -->
						@foreach (var account in accounts)
						{
							<tr>
								<td>@account.UserName</td>
								<td>
									<input type="checkbox" class="user-checkbox" data-user-id="@account.Id" name="selectedUsers">
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary" onclick="inviteUsers()">Invite</button>
			</div>
		</div>
	</div>
</div>

<!-- Hiển thị tên file hình ảnh -->
<script>
	// Lắng nghe sự kiện khi input file thay đổi
	document.getElementById('editFileInput').addEventListener('change', function () {
		// Lấy tên của file được chọn
		var fileName = this.files[0].name;

		// Đặt tên file vào ô input
		document.getElementById('editCurrentImagePath').value = fileName;
	});
</script>

<!-- Hiển thị modal danh sách account -->
<script>
	// Function to show the invite modal
	function showInviteModal() {
		$('#editInviteModal').modal('show'); // Show the invite modal
	}

	// Add an event listener to the Invite button
	document.getElementById('editInviteButton').addEventListener('click', function () {
		showInviteModal(); // Call the function to show the invite modal
	});
</script>


<!-- Modal Popup for Delete Confirmation -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				Are you sure you want to delete this project?
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
			</div>
		</div>
	</div>
</div>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
	var id;
	// JavaScript for handling delete confirmation
	$(document).ready(function () {
		$('.deleterow').on('click', function () {
			id = $(this).data('id');
			console.log(id);
			$('#confirmDelete').data('id', id); // Set data-id attribute for the delete button
		});

		// Xóa nhà hàng khi nhấn nút "Xóa" trên modal
		$('#confirmDelete').click(function () {
			var url = '/Admin/Projects/Delete/' + id;

			$.ajax({
				type: "POST",
				url: url,
				headers: {
					RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
				},
				success: function (data) {
					alert("Đã xóa thành công");
					location.reload();
				},
				error: function (data) {
					alert("Xóa thất bại");
				}
			});
		});
	});
</script>

<script>
	$(document).ready(function () {

		$('.editButton').click(function () {
			var id = $(this).data('id');
			var name = $(this).data('name');
			var currentImage = $(this).data('image');
			var startDateString = $(this).data('startdate');
			var endDateString = $(this).data('enddate');
			var description = $(this).data('description');
			
			$('#editId').val(id);
			$('#editProjectName').val(name);
			$('#currentImage').attr('src', currentImage);
			$('#currentImagePath').val(currentImage);
			$('#editDescription').val(description);

			$('#editCategoryModal').modal('show');
		}); 


		function displaySelectedImage() {
			var fileInput = $('#fileInput')[0];
			var currentImage = document.getElementById('currentImage');
			var currentImagePath = document.getElementById('currentImagePath');
			var selectedFile = fileInput.files[0];
			if (selectedFile) {
				var reader = new FileReader();
				reader.onload = function (e) {
					currentImage.src = e.target.result;
				};
				reader.readAsDataURL(selectedFile);

				currentImagePath.value = selectedFile.name;
			}
		}

		$('#fileInput').change(displaySelectedImage);

		$('#editCategoryForm').submit(function (e) {
			e.preventDefault();

			var formData = new FormData(this);

			$.ajax({
				type: 'POST',
				url: '/Admin/Projects/Edit/' + $('#editId').val(),
				data: formData,
				contentType: false,
				processData: false,
				success: function (data) {
					$('#editCategoryModal').modal('hide');
					location.reload();
				},
				error: function (xhr, status, error) {
					console.error(xhr.responseText);
				}
			});
		});
	});
</script>

<script>
	
</script>
